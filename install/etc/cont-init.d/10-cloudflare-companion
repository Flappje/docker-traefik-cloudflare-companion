#!/usr/bin/with-contenv bash

source /assets/functions/00-container
prepare_service single
PROCESS_NAME="traefik-cloudflare-companion"

### Sanity Test
sanity_var TARGET_DOMAIN "Target Domain"
sanity_var DOMAIN1 "Domain 1"
sanity_var DOMAIN1_ZONE_ID "Domain 1 Zone ID"

### Scoped vs Global API Key determination
case "$API_MODE" in
    "SCOPED" | "scoped" )
        print_debug "Using Cloudflare Scoped API mode"
        file_env 'CF_API_TOKEN'
        api_mode=$(cat <<EOF
cf = CloudFlare.CloudFlare()
EOF
        )
    ;;
    "GLOBAL" | "global" | "LEGACY" | "legacy" )
        print_debug "Using Global API mode"
        file_env 'CF_EMAIL'
        file_env 'CF_TOKEN'
        api_mode=$(cat <<EOF
email = os.environ['CF_EMAIL']
token = os.environ['CF_TOKEN']
cf = CloudFlare.CloudFlare(email=email , token=token)
EOF
        )
    ;;
    *)
        print_debug "Unknown API_MODE variable. Exiting.."
        exit 1
    ;;
esac

### Swarm Mode Functionality
if var_true "${SWARM_MODE}" ; then
    print_debug "Swarm Mode Enabled"
    if [ "$TRAEFIK_VERSION" = "2" ] ; then
        labels_location=$(cat <<EOF
    for prop in c.attrs.get(u'Spec').get(u'Labels'):
         if re.match('traefik.*?\.rule', prop) :
            value = c.attrs.get(u'Spec').get(u'Labels').get(prop)
EOF
        )
    else
        labels_location=$(cat <<EOF
    for prop in c.attrs.get(u'Spec').get(u'Labels'):
         if re.match('traefik.*.frontend.rule', prop) :
            value = c.attrs.get(u'Spec').get(u'Labels').get(prop)
EOF
        )
    fi

    list=$(cat <<EOF
    for c in client.services.list():
EOF
            )

    check=$(cat <<EOF
            check_container(client.services.get(event.get(u'id')))
EOF
            )
else
    print_debug "Swarm Mode Disabled"
    if [ "$TRAEFIK_VERSION" = "2" ] ; then
        labels_location=$(cat <<EOF
    for prop in c.attrs.get(u'Config').get(u'Labels'):
         if re.match('traefik.*?\.rule', prop) :
            value = c.attrs.get(u'Config').get(u'Labels').get(prop)
EOF
        )
    else
        labels_location=$(cat <<EOF
    for prop in c.attrs.get(u'Config').get(u'Labels'):
         if re.match('traefik.*.frontend.rule', prop) :
            value = c.attrs.get(u'Config').get(u'Labels').get(prop)
EOF
        )
    fi

    list=$(cat <<EOF
    for c in client.containers.list(all=True):
EOF
            )

    check=$(cat <<EOF
            check_container(client.containers.get(event.get(u'id')))
EOF
            )
fi


### Are we refreshing/deleting entries before adding the entry
if var_true "${REFRESH_ENTRIES}" ; then
    print_debug "Refreshing Entries Enabled"
else
    print_debug "Refreshing Entries Disabled"
fi

### Create the Script
print_debug "Start creating script"
cat <<EOF > /usr/sbin/cloudflare-companion
#!/usr/bin/python

import os
import re
import docker
import CloudFlare
from datetime import datetime

def point_domain(name):
    try:
EOF

### Loop through DOMAIN* Variables
    print_debug "Loop through DOMAIN* variables"
    NUM=$(printenv | sort | grep -c '\DOMAIN.*')
    for (( i = 1; i <= NUM; i++ ))
        do
        domain_tmp=DOMAIN${i}
        if [ "${!domain_tmp}" != "" ] ; then
            cat <<EOF >> /usr/sbin/cloudflare-companion

            domain${i} = os.environ['DOMAIN${i}']
            zone_id${i} = os.environ['DOMAIN${i}_ZONE_ID']

            try:
                if os.environ['DOMAIN${i}_PROXIED'].upper() == "TRUE":
                    proxied_flag${i} = True
                else:
                    proxied_flag${i} = False
            except KeyError:
                proxied_flag${i} = False

EOF
        ### Are we refreshing/deleting entries before adding the entry
        if var_true "${REFRESH_ENTRIES}" ; then
                cat <<EOF >> /usr/sbin/cloudflare-companion
            if name.find(domain${i}) != -1:
                try:
                    records = cf.zones.dns_records.get(zone_id${i}, params={u'name':name})
                    data_dict = {
                        u'type': u'CNAME',
                        u'name': name,
                        u'content': target_domain,
                        u'ttl': ${DEFAULT_TTL},
                        u'proxied': proxied_flag${i}
                    }
                    if len(records) == 0:
                        cf.zones.dns_records.post(zone_id${i},data=data_dict)
                        print "Created new record: ", name, "to point to", target_domain
                    else:
                        for record in records:
                            cf.zones.dns_records.put(zone_id${i}, record["id"], data=data_dict)
                            print "Updated existing record: ", name, "to point to", target_domain
                except CloudFlare.exceptions.CloudFlareAPIError as e:
                    pass
EOF
            else
                cat <<EOF >> /usr/sbin/cloudflare-companion
            if name.find(domain${i}) != -1:
                print "Created new record: ", name, "to point to", target_domain
                r = cf.zones.dns_records.post(zone_id${i},data={u'type': u'CNAME', u'name': name, u'content': target_domain, u'ttl': ${DEFAULT_TTL}, u'proxied': proxied_flag${i}} )
EOF
            fi
        fi
        done

### Support Traefik 1 or 2
print_debug "Determine whether Traefik 1.x or 2.x"
if [ "${TRAEFIK_VERSION}" = "2" ] ; then
    print_notice "Setting Traefik 2.x Mode"
    cat <<EOF >> /usr/sbin/cloudflare-companion
    except CloudFlare.exceptions.CloudFlareAPIError as e:
        print '** %s - %d %s' % (name, e, e)

def check_container(c):
${labels_location}
            if 'Host' in value:
                print "container rule value: ", value
                extracted_domains = re.findall(r'Host.*?\(\`(.*?)\`\)', value)
                print "extracted_domains from rule: ", extracted_domains
                cont_id = c.attrs.get(u'Id')
                if len(extracted_domains) > 1:
                    for v in extracted_domains:
                        print "Found Container:",cont_id,"with Multi-Hostname",v
                        point_domain(v)
                elif len(extracted_domains) == 1:
                    print "Found Container:",cont_id,"with Hostname", extracted_domains[0]
                    point_domain(extracted_domains[0])
            else:
                pass

EOF
else
    print_notice "Setting Traefik 1.x Mode"
    cat <<EOF >> /usr/sbin/cloudflare-companion
    except CloudFlare.exceptions.CloudFlareAPIError as e:
        print '** %s - %d %s' % (name, e, e)

def check_container(c):
${labels_location}
            if 'Host:' in value:
                value = value.split("Host:")[1].strip()
                cont_id = c.attrs.get(u'Id')
                if ',' in value:
                    for v in value.split(","):
                        print "Found Container:",cont_id,"with Multi-Hostname",v
                        point_domain(v)
                else:
                    print "Found Container:",cont_id,"with Hostname", value
                    point_domain(value)
            else:
                pass

EOF
fi

### Finish rest of script
print_debug "Finish rest of script"
cat <<EOF >> /usr/sbin/cloudflare-companion
def init():
${list}
        check_container(c)

target_domain = os.environ['TARGET_DOMAIN']
domain = os.environ['DOMAIN1']

${api_mode}
client = docker.from_env()

init()

t = datetime.now().time().strftime("%s")

for event in client.events(since=t, filters={'status': u'start'}, decode=True):
    if event.get(u'status') == u'start':
        try:
${check}
        except docker.errors.NotFound as e:
            pass
EOF

chmod +x /usr/sbin/cloudflare-companion

liftoff
